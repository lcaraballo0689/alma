import{_,c as n,o as l,b as o,e as w,t as m,h as S,d as C,p as F,q as M,a as b,x as R,F as g,f as v,S as p,i as x,j as y,u as k,l as E}from"./index-BzoUKLuT.js";import{r as L,u as A}from"./xlsx-xCRnwQcp.js";import{u as P}from"./userStore-BA3gqfiU.js";const B="/assets/lost-BuFeU7t5.gif",I="/assets/empty-D9xVql5Q.mp4",U={name:"EmptyState",props:{message:{type:String,default:"No se han cargado registros del archivo."}},data(){return{lost:B,lostVideo:I}}},j={class:"empty-state"},z={width:"300",autoplay:"",loop:"",muted:"",playsinline:""},D=["src"],N={class:"text-muted",style:{"margin-top":"-30px"}};function V(i,t,c,d,e,s){return l(),n("div",j,[o("video",z,[o("source",{src:e.lostVideo,type:"video/mp4"},null,8,D),t[0]||(t[0]=w(" Tu navegador no soporta el elemento video. "))]),o("h4",N,m(c.message),1)])}const H=_(U,[["render",V],["__scopeId","data-v-d4872fc8"]]),T={name:"MassUpload",components:{EmptyState:H},data(){return{selectedFile:null,observacion:"",uploadMessage:"",uploadData:[],selectedHeaders:[],fileRecords:[],currentPageFileRecords:1,recordsPerPageFile:2e4,localMassAction:"",loaderStore:E(),hoveredButton:""}},computed:{actionLabel(){return this.localMassAction==="prestamo-masivo"?"Préstamos Masivos":this.localMassAction==="devolucion-masiva"?"Devoluciones Masivas":"Acción Masiva"},endpointUpload(){return this.localMassAction==="prestamo-masivo"||this.localMassAction==="devolucion-masiva"?"/api/excel/cargar":""},endpointPlantilla(){return this.localMassAction==="prestamo-masivo"||this.localMassAction==="devolucion-masiva"?"/api/excel/plantilla":""},expectedHeaders(){return this.localMassAction==="prestamo-masivo"?["referencia2","direccion_entrega","urgencia"]:this.localMassAction==="devolucion-masiva"?["prestamoId","nuevo_estado"]:[]},emailCliente(){var t;return((t=y().user)==null?void 0:t.email)||""},paginatedFileRecords(){const t=this.currentPageFileRecords*this.recordsPerPageFile;return this.fileRecords.slice(0,t)},hasMoreFileRecords(){return this.fileRecords.length>this.paginatedFileRecords.length}},mounted(){const i=P();this.localMassAction=i.getMassAction,console.log("Local massAction:",this.localMassAction)},methods:{volver(){const i=k();console.log("Antes de revertir, tabStore:",i),i.revertTab()},async descargarPlantilla(){if(!this.endpointPlantilla){this.loaderStore.hideLoader(),p.fire({icon:"warning",title:"Plantilla no disponible",text:"No se ha configurado una plantilla para esta acción masiva."});return}const t=y().token,c=this.localMassAction||"prestamo-masivo",d=this.endpointPlantilla,e=d+(d.includes("?")?"&":"?")+`tipo=${encodeURIComponent(c)}&token=${encodeURIComponent(t)}`;try{const s=await x.get(e,{responseType:"blob"}),u=new Blob([s.data]),r=window.URL.createObjectURL(u),a=document.createElement("a");a.href=r;let f="plantilla.xlsx";if(s.headers["content-disposition"]){const h=s.headers["content-disposition"].match(/filename="(.+)"/);h&&h.length===2&&(f=h[1])}a.setAttribute("download",f),document.body.appendChild(a),a.click(),document.body.removeChild(a),window.URL.revokeObjectURL(r)}catch(s){console.error("Error descargando la plantilla:",s),this.loaderStore.hideLoader(),p.fire({icon:"error",title:"Error",text:"Error al descargar la plantilla."})}},handleFileChange(i){const t=i.target.files[0];if(this.selectedFile=t,t){const c=new FileReader;c.onload=d=>{const e=d.target.result,s=L(e,{type:"binary"}),u=s.SheetNames[0],r=s.Sheets[u],a=A.sheet_to_json(r,{header:1});this.selectedHeaders=a[0]||[],this.fileRecords=a.slice(1),this.currentPageFileRecords=1,this.fileRecords.length===0&&(this.loaderStore.hideLoader(),p.fire({icon:"warning",title:"Sin registros",text:"El archivo Excel seleccionado no contiene registros.",timer:3e3,showConfirmButton:!1}).then(()=>{this.selectedFile=null,this.selectedHeaders=[],this.fileRecords=[],this.$refs.fileInput.value=""}))},c.readAsBinaryString(t)}},loadMoreFileRecords(){this.currentPageFileRecords++},async uploadFile(){if(!this.selectedFile){this.loaderStore.hideLoader(),p.fire({icon:"warning",title:"Archivo no seleccionado",text:"Por favor, seleccione un archivo Excel."});return}const i=this.selectedHeaders.map(e=>e.trim().toLowerCase()),t=this.expectedHeaders.map(e=>e.trim().toLowerCase());let c=[];for(let e=0;e<t.length;e++)i[e]!==t[e]&&c.push(`Posición ${e+1}: se esperaba "${t[e]}", pero se encontró "${i[e]||"vacío"}"`);if(c.length>0){this.loaderStore.hideLoader(),p.fire({icon:"error",title:"Error en encabezados",timer:5e3,html:`
        <div style="text-align: left; font-size: 14px; line-height: 1.4;">
          <p style="margin-bottom: 10px;">Los encabezados del archivo Excel no coinciden con los requeridos:</p>
          <ul style="margin: 0; padding-left: 20px;">
            ${c.map(e=>`<li>${e}</li>`).join("")}
          </ul>
        </div>
      `}).then(()=>{this.loaderStore.hideLoader(),p.fire({toast:!0,position:"bottom-end",icon:"error",title:"Encabezados incorrectos",text:"Verifique los encabezados del archivo Excel.",timer:1e4,timerProgressBar:!0,showConfirmButton:!1})});return}this.loaderStore.showLoader();const d=new FormData;d.append("file",this.selectedFile),d.append("usuarioEmail",this.emailCliente),d.append("observacion",this.observacion);try{const e=await x.post(this.endpointUpload,d,{headers:{"Content-Type":"multipart/form-data"}});if(e.data.errores&&e.data.errores.length>0){const s=e.data.creados.length,u=e.data.errores.length,r=s+u;this.loaderStore.hideLoader(),p.fire({icon:"warning",width:"700px",title:"Carga parcial completada",html:`<p>Se cargaron ${s} de ${r} registros.</p>
               <p><strong>Errores encontrados:</strong></p>
                <div style="max-height: 200px; overflow-y: auto; text-align: left;">
               <ul style="text-align: left;">
                 ${e.data.errores.map(a=>`<li>${a.error} (fila ${a.fila})</li>`).join("")}
               </ul>
                </div>`,showConfirmButton:!0})}else this.loaderStore.hideLoader(),p.fire({icon:"success",title:"Éxito",text:e.data.message||"Carga masiva realizada exitosamente.",timer:1500,showConfirmButton:!1});this.uploadMessage=e.data.message||"Carga masiva realizada exitosamente.",this.uploadData=e.data.data||[],this.volver()}catch(e){if(console.error("Error en la carga masiva:",e),e.response&&e.response.data&&(e.response.data.errores||e.response.data.error)){const s=e.response.data.errores?`<ul style="text-align: left;">${e.response.data.errores.map(u=>`<li>${u.error} (fila ${u.fila})</li>`).join("")}</ul>`:"";this.loaderStore.hideLoader(),p.fire({icon:"error",width:"700px",title:"Error en la carga masiva",html:`<p>${e.response.data.error||"Se encontraron errores al procesar la carga."}</p>
         <div style="max-height: 200px; overflow-y: auto; text-align: left;">
        ${s}
         </div>`,showConfirmButton:!0})}else this.loaderStore.hideLoader(),p.fire({icon:"error",title:"Error",text:"Error al realizar la carga masiva. Inténtelo nuevamente."});this.uploadMessage="Error al realizar la carga masiva. Inténtelo nuevamente."}}}},$={class:"container-fluid m-0 p-0"},q={class:"mass-upload-container m-0 p-0"},O={class:"row p-0 m-0"},Q={class:"col-md-4 mb-3"},Z={class:"card shadow-sm"},G={class:"card-header d-flex justify-content-between align-items-center"},J={class:"text-uppercase"},K={key:0},W={key:1},X={class:"card-body"},Y={class:"mb-3"},ee={class:"mb-3"},te={class:"d-flex justify-content-between"},oe=["disabled"],se={class:"col-md-8 mb-3"},re={class:"card shadow-sm"},ae={class:"card-header d-flex justify-content-between align-items-center"},ie={key:0},le={class:"card-body m-0 p-0"},ne={key:0},ce={class:"table table-bordered m-0 p-0"};function de(i,t,c,d,e,s){const u=S("EmptyState");return l(),n("div",$,[o("div",q,[o("div",O,[o("div",Q,[o("div",Z,[o("div",G,[o("div",null,[t[8]||(t[8]=o("i",{class:"bi bi-files-alt me-2"},null,-1)),o("strong",J,"Carga masiva de "+m(s.actionLabel),1)]),o("button",{class:"custom-btn excel",onClick:t[0]||(t[0]=(...r)=>s.descargarPlantilla&&s.descargarPlantilla(...r)),onMouseover:t[1]||(t[1]=r=>e.hoveredButton="excel"),onMouseleave:t[2]||(t[2]=r=>e.hoveredButton="")},[o("i",{class:C(e.hoveredButton==="excel"?"bi bi-arrow-down-circle-fill":"bi bi-file-excel-fill")},null,2),e.hoveredButton!=="excel"?(l(),n("span",K,"Plantilla")):(l(),n("span",W,"Descargar"))],32)]),o("div",X,[o("div",Y,[t[9]||(t[9]=o("label",{for:"fileInput",class:"form-label"},"Selecciona el archivo Excel",-1)),o("input",{ref:"fileInput",id:"fileInput",type:"file",accept:".xlsx",class:"form-control",onChange:t[3]||(t[3]=(...r)=>s.handleFileChange&&s.handleFileChange(...r))},null,544)]),o("div",ee,[t[10]||(t[10]=o("label",{for:"observacionInput",class:"form-label"},"Observación",-1)),F(o("input",{id:"observacionInput",type:"text","onUpdate:modelValue":t[4]||(t[4]=r=>e.observacion=r),class:"form-control",placeholder:"Ingrese observación global"},null,512),[[M,e.observacion]])]),o("div",te,[o("button",{class:"custom-btn",style:{"background-color":"black",color:"white"},onClick:t[5]||(t[5]=(...r)=>s.uploadFile&&s.uploadFile(...r)),disabled:!e.selectedFile},t[11]||(t[11]=[o("i",{class:"'bi bi-cloud-arrow-up-fill text-white'"},null,-1),o("span",null,"Cargar archivo",-1)]),8,oe),o("button",{class:"custom-btn",onClick:t[6]||(t[6]=(...r)=>s.volver&&s.volver(...r))},t[12]||(t[12]=[o("i",{class:"'bi bi-arrow-down-left-circle text-dark'"},null,-1),o("span",null,"Cancelar y regresar ",-1)]))])])])]),o("div",se,[o("div",re,[o("div",ae,[t[13]||(t[13]=o("div",null,[o("i",{class:"bi bi-eye-fill me-2"}),o("strong",null,"PREVISUALIZACIÓN")],-1)),e.fileRecords.length>0?(l(),n("strong",ie,"Registros: "+m(e.fileRecords.length),1)):b("",!0)]),o("div",le,[e.fileRecords.length>0?(l(),n("div",ne,[o("table",ce,[o("thead",null,[o("tr",null,[(l(!0),n(g,null,v(s.expectedHeaders,(r,a)=>(l(),n("th",{class:"text-uppercase text-center",key:a},m(r==="referencia2"?"Referencia":r==="direccion_entrega"?"Dirección":r==="urgencia"?"Urgencia":r),1))),128))])]),o("tbody",null,[(l(!0),n(g,null,v(s.paginatedFileRecords,(r,a)=>(l(),n("tr",{key:a},[(l(!0),n(g,null,v(r,(f,h)=>(l(),n("td",{class:"text-center",key:h},m(f),1))),128))]))),128))])]),s.hasMoreFileRecords?(l(),n("button",{key:0,class:"btn btn-sm btn-outline-secondary",onClick:t[7]||(t[7]=(...r)=>s.loadMoreFileRecords&&s.loadMoreFileRecords(...r))}," Cargar más registros ")):b("",!0)])):(l(),R(u,{key:1}))])])])])])])}const me=_(T,[["render",de],["__scopeId","data-v-7decc936"]]);export{me as default};
